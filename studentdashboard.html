<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard - Attendify</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">

  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-50">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-20">
      <div>
        <a href="/" class="text-3xl font-bold text-indigo-600">Attendify</a>
        <span class="ml-4 text-xl text-gray-700">Student Dashboard</span>
      </div>
      <button id="logoutBtn"
        class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-red-600 transition-colors">
        Logout
      </button>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="container mx-auto p-4 sm:p-6 lg:p-8">
    <h1 id="welcomeMsg" class="text-3xl font-bold text-gray-900 mb-6">
      Loading...
    </h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left Column: Student Details -->
      <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-xl border border-gray-100 h-fit">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Your Details</h2>

        <div class="space-y-4">
          <div>
            <span class="block text-sm font-medium text-gray-500">Registration No.</span>
            <span id="regNumberDisplay" class="text-lg font-semibold text-gray-800">...</span>
          </div>
          <div>
            <span class="block text-sm font-medium text-gray-500">Your Name</span>
            <span id="profileNameDisplay" class="text-lg font-semibold text-gray-800">Student</span>
          </div>
        </div>

        <!-- Manual QR Input -->
        <div class="mt-8">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">Mark Attendance Manually</h3>
          <p class="text-sm text-gray-600 mb-2">
            Paste the QR payload you scanned on your mobile phone below.
          </p>
          <textarea id="qrPayloadInput" rows="4" placeholder='{"subject":"Math","qrId":"123abc"}'
            class="w-full border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500"></textarea>
          <button id="submitQrBtn"
            class="mt-3 bg-indigo-600 text-white px-4 py-3 rounded-xl hover:bg-indigo-700 w-full">
            âœ… Submit Attendance
          </button>
        </div>
      </div>

      <!-- Right Column: Attendance History -->
      <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Attendance History</h2>
        <p class="text-sm text-gray-600 mb-6">
          Paste the QR payload from your mobile device to mark attendance. Your updated attendance will appear below.
        </p>
        <ul id="attendanceHistory" class="space-y-3">
          <li class="text-gray-500">No attendance records available.</li>
        </ul>
      </div>
    </div>

    <!-- ===== Attendance Summary Section ===== -->
    <section class="mt-10 space-y-8">
      <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Attendance Summary</h2>
        <div id="summaryContainer" class="space-y-5">
          <p class="text-gray-500">No data yet.</p>
        </div>
      </div>
    </section>
  </main>

  <script>
    const regNumber = sessionStorage.getItem('studentRegNumber');
    const regNumberDisplay = document.getElementById("regNumberDisplay");
    const welcomeMsg = document.getElementById("welcomeMsg");
    const logoutBtn = document.getElementById("logoutBtn");
    const BASE_URL = window.location.origin;

    const attendanceList = document.getElementById('attendanceHistory');
    const summaryContainer = document.getElementById('summaryContainer');
    const submitQrBtn = document.getElementById('submitQrBtn');
    const qrPayloadInput = document.getElementById('qrPayloadInput');

    // Redirect if not logged in
    if (!regNumber) {
      window.location.href = "./studentlogin.html";
    } else {
      regNumberDisplay.textContent = regNumber;
      welcomeMsg.textContent = `Welcome, ${regNumber}!`;
    }

    // Logout
    logoutBtn.addEventListener("click", () => {
      sessionStorage.removeItem("studentRegNumber");
      window.location.href = "/";
    });

    // Submit QR manually
    submitQrBtn.addEventListener('click', async () => {
      const qrText = qrPayloadInput.value.trim();
      if (!qrText) {
        alert('Please paste the QR payload first.');
        return;
      }

      try {
        const data = JSON.parse(qrText);

        const res = await fetch(`${BASE_URL}/attendance/mark`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            regNumber,
            subject: data.subject,
            qrId: data.qrId
          }),
        });

        const result = await res.json();
        alert(result.message);
        loadAttendance();
      } catch (err) {
        alert('Invalid payload or server error.');
        console.error(err);
      }
    });

    // Fetch attendance records
    async function loadAttendance() {
      try {
        const res = await fetch(`${BASE_URL}/attendance/${regNumber}`);
        const data = await res.json();
        attendanceList.innerHTML = '';

        if (!data.records || data.records.length === 0) {
          attendanceList.innerHTML = '<li class="text-gray-500">No attendance yet.</li>';
          summaryContainer.innerHTML = '<p class="text-gray-500">No data yet.</p>';
          return;
        }

        data.records.forEach(r => {
          const li = document.createElement('li');
          li.className = 'flex justify-between bg-white p-4 rounded-lg shadow-sm border';
          li.innerHTML = `
            <span class="font-semibold text-indigo-700">${r.subject}</span>
            <span class="${r.scoreChange > 0 ? 'text-green-600' : 'text-red-600'} font-semibold">
              ${r.scoreChange > 0 ? '+1' : '-3'}
            </span>
            <span class="text-gray-500">${r.date}</span>
          `;
          attendanceList.appendChild(li);
        });

        const total = data.records.length;
        const present = data.records.filter(r => r.scoreChange > 0).length;
        const absent = total - present;

        summaryContainer.innerHTML = `
          <p>Total Classes: <strong>${total}</strong></p>
          <p>Present: <strong class="text-green-600">${present}</strong></p>
          <p>Absent: <strong class="text-red-600">${absent}</strong></p>
        `;
      } catch (err) {
        console.error('Error fetching attendance:', err);
        attendanceList.innerHTML = '<li class="text-red-500">Error loading attendance data.</li>';
        summaryContainer.innerHTML = '<p class="text-red-500">Error loading summary.</p>';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadAttendance();
    });
  </script>

</body>
</html>
